name: Swift

on:
  push:
    branches: [ "wasm32-wasi" ]
  pull_request:
    branches: [ "wasm32-wasi" ]

jobs:
  build:

    runs-on: macos-12

    steps:
    - uses: actions/checkout@v3
    - name: Select Xcode
      run: sudo xcode-select -s /Applications/Xcode_14.1.app
    - name: Install tools
      run: brew install wabt binaryen
    - name: Install Wasm Toolchain
      run: |
        VERSION=swift-wasm-DEVELOPMENT-SNAPSHOT-2022-10-04-a
        TOOLCHAIN_URL="https://github.com/swiftwasm/swift/releases/download/$VERSION/$VERSION-macos_x86_64.pkg"
        curl -LO $TOOLCHAIN_URL
        installer -target CurrentUserHomeDirectory -pkg $VERSION-macos_x86_64.pkg
        echo "PATH=$HOME/Library/Developer/Toolchains/$VERSION.xctoolchain/usr/bin:${PATH}" >> $GITHUB_ENV
    - name: Build
      run: |
        swift build --product swift-format --triple wasm32-unknown-wasi -c release -Xlinker -z -Xlinker stack-size=262144
        wasm-strip .build/release/swift-format.wasm
        wasm-opt -Os .build/release/swift-format.wasm -o swift-format.wasm
    - name: Checkout WasmTransformer
      uses: actions/checkout@v3
      with:
        repository: swiftwasm/WasmTransformer
        ref: 0.4.1
        path: WasmTransformer
    - name: Lower i64 imports to i32
      run: |
        swift run wasm-trans ../swift-format.wasm --i64-to-i32-lowering -o ../swift-format-lowered.wasm
      working-directory: ./WasmTransformer
    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: binaries
        path: swift-format*.wasm
